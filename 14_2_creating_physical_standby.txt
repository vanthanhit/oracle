
--Add network adapter
--primary
ipv4 : 192.168.56.101
netmask : 255.255.255.0
gateway : 0.0.0.0

--standby
ipv4 : 192.168.56.102
netmask : 255.255.255.0
gateway : 0.0.0.0


--Start listener and database if they are not opened already
$ lsnrctl start

$ sqlplus / as sysdba

SQL> startup;


--Control archivelog mod
SQL> archive log list

SQL> select log_mode from v$database;

--If it is noarchivelog mode, switch is to archivelog mode
SQL> shutdown immediate;

SQL> startup mount;

SQL> alter database archivelog;

SQL> alter database open;


--Enable force logging and flashback on the primary
SQL> alter database force logging;

SQL> alter database flashback on;  
####If fail (ORA-38706), create desr Recevery Area ####
SELECT name, value FROM v$parameter WHERE name = 'db_recovery_file_dest';
ALTER SYSTEM SET db_recovery_file_dest_size='2G' SCOPE=BOTH;
ALTER SYSTEM SET db_recovery_file_dest='/u02/oradata/RecoverArea' SCOPE=BOTH;
alter database flashback on;  


--Create standby redologs
SQL> select GROUP#,THREAD#,BYTES/1024/1024 from v$log;

SQL> select member from v$logfile;

SQL> alter database add standby logfile '/u02/oradata/CDB/redostb01.log' size 209715200;

SQL> alter database add standby logfile '/u02/oradata/CDB/redostb02.log' size 209715200;

SQL> alter database add standby logfile '/u02/oradata/CDB/redostb03.log' size 209715200;


--Adjust some initialization parameters:
SQL> show parameter db_name

SQL> show parameter db_unique_name

SQL> alter system set db_unique_name=cdbprm scope=spfile;

--Remote_login_password:
SQL> show parameter remote_login_password
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
remote_login_passwordfile            string      EXCLUSIVE

-- LOG_ARCHIVE_CONFIG:
SQL> alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(cdbprm,cdbstb)' scope = spfile;

-- LOG_ARHIVE_DEST_1:
SQL> alter system set LOG_ARCHIVE_DEST_1='LOCATION=USE_DB_RECOVERY_FILE_DEST VALID_FOR=(ALL_LOGFILES,ALL_ROLES) 
DB_UNIQUE_NAME=cdbprm' scope = spfile;

-- Parameter for Swicth- Failover:
SQL> alter system set FAL_SERVER='cdbstb' scope = spfile;

SQL> alter system set STANDBY_FILE_MANAGEMENT=AUTO scope = spfile;


--Restart the database and check parameters
SQL> shutdown immediate;

SQL> startup;

SQL> set linesize 500 pages 100
SQL> col name format a30
SQL> col value format a100
SQL> select name, value
from v$parameter
where name in ('db_name','db_unique_name','log_archive_config',
'log_archive_dest_1','log_archive_dest_2',
'log_archive_dest_state_1','log_archive_dest_state_2',
'remote_login_passwordfile', 'log_archive_format', 'log_archive_max_processes',
'fal_server','db_file_name_convert', 'log_file_name_convert', 'standby_file_management');


--Network configuration

--Edit file listener.ora
$ cd $ORACLE_HOME/network/admin

$ vi listener.ora

--add following lines
SID_LIST_LISTENER =
 (SID_LIST =
  (SID_DESC =
   (GLOBAL_DBNAME = cdbprm)
   (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
   (SID_NAME = cdb)
 )
  (SID_DESC =
   (GLOBAL_DBNAME = cdbprm_dgmgrl)
   (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
   (SID_NAME = cdb)
  )
)

--Add following lines to the file tnsnames.ora
$ vi tnsnames.ora

# Data Guard
PRIMARY =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = cdbprm)
   (UR=A)
  )
 )

STANDBY =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7-stby.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = cdbstb)
   (UR=A)
  )
 )

ERP =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = ERP)
  )
 )

LISTENER_ORCL =
(ADDRESS = (PROTOCOL = TCP)(HOST = ol7.localdomain)(PORT = 1521))

--Restart the listener
$ lsnrctl stop 

$ lsnrctl start 

--modify /etc/hosts file
$ su root

$ vi /etc/hosts

192.168.56.101 ol7.localdomain ol7
192.168.56.102 ol7-stby.localdomain ol7-stby

--exit to oracle user


--Creating a physical standby database
--in primary server
$ sqlplus / as sysdba

SQL> create pfile='/tmp/initcdb.ora' from spfile;

--Copy files orapw file and initorcl.ora to server standby
$ scp /tmp/initcdb.ora ol7-stby:/tmp/

$ scp /u01/app/oracle/product/19.0.0/dbhome_1/dbs/orapwcdb ol7-stby:/u01/app/oracle/product/19.0.0/dbhome_1/dbs/


--standby server
$ mkdir -p /u01/app/oracle/admin/cdb

$ mkdir -p /u01/app/oracle/admin/cdb/adump

$ mkdir -p /u02/oradata/RecoverArea

$ mkdir -p /u02/oradata/RecoverArea/CDB

$ mkdir -p /u02/oradata/CDB

$ mkdir -p /u02/oradata/CDB/pdbseed

$ mkdir -p /u02/oradata/CDB/erp


--Modify the parameter in the created /tmp/initcdb.ora file
$ vi /tmp/initcdb.ora

*.db_unique_name='cdbstb'
*.fal_server='cdbprm'
*.log_archive_config='DG_CONFIG=(cdbstb,cdbprm)'
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=cdbstb'

--Create an entry in the /etc/oratab:
cdb:/u01/app/oracle/product/19.0.0/dbhome_1:N


--Network configuration

--Edit file listener.ora
$ cd $ORACLE_HOME/network/admin

--Add following lines
$ vi listener.ora

SID_LIST_LISTENER =
 (SID_LIST =
  (SID_DESC =
   (GLOBAL_DBNAME = cdbstb)
   (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
   (SID_NAME = cdb)
  )
  (SID_DESC =
   (GLOBAL_DBNAME = cdbstb_dgmgrl)
   (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
   (SID_NAME = cdb)
  )
)

--Add following lines to the file tnsnames.ora
$ vi tnsnames.ora

# Data Guard
PRIMARY =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = cdbprm)
   (UR=A)
  )
 )

STANDBY =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7-stby.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = cdbstb)
   (UR=A)
  )
 )

ERP =
 (DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = ol7-stby.localdomain)(PORT = 1521))
  (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = ERP)
  )
 )

LISTENER_ORCL =
(ADDRESS = (PROTOCOL = TCP)(HOST = ol7.localdomain)(PORT = 1521))

--Restart the listener:
$ lsnrctl stop

$ lsnrctl start

--modify /etc/hosts file
$ su root

$ vi /etc/hosts

192.168.56.101 ol7.localdomain primary
192.168.56.102 ol7-stby.localdomain standby

--exit to oracle user


--Start standby database and create the spfile:

--Set environment:
$ . oraenv
ORACLE_SID = [orcl] ? orcl

$ sqlplus / as sysdba

SQL> startup nomount pfile='/tmp/initorcl.ora';

SQL> create spfile from pfile='/tmp/initorcl.ora';

SQL> shutdown immediate;

SQL> startup nomount;

--Start duplication
$ rman target sys/oracle@primary auxiliary sys/oracle@standby

RMAN> DUPLICATE TARGET DATABASE
FOR STANDBY
FROM ACTIVE DATABASE
NOFILENAMECHECK;

--Check the database role on the standby
$ sqlplus / as sysdba

SQL> select database_role from v$database;


--Check database parameters on the physical standby
SQL> set linesize 500 pages 100

SQL> col name for a30

SQL> col value forma a100

SQL> select name, value from v$parameter
where name in ('db_name','db_unique_name','log_archive_config',
'log_archive_dest_1','log_archive_dest_2',
'log_archive_dest_state_1','log_archive_dest_state_2',
'remote_login_passwordfile', 'log_archive_format', 'log_archive_max_processes',
'fal_server','db_file_name_convert', 'log_file_name_convert', 'standby_file_management');


--Create standby logfiles:
SQL> ALTER DATABASE ADD STANDBY LOGFILE 'u02/oradata/CDB/redostb01.log' size 209715200;

SQL> ALTER DATABASE ADD STANDBY LOGFILE 'u02/oradata/CDB/redostb02.log' size 209715200;

SQL> ALTER DATABASE ADD STANDBY LOGFILE 'u02/oradata/CDB/redostb03.log' size 209715200;


-- on both servers
$ sqlplus / as sysdba

SQL> alter system set dg_broker_start=true scope=both;

--Creating a Data Guard configuration via a tool DGMGRL on primary server
$ dgmgrl /

DGMGRL> create configuration orcl as primary database is cdbprm connect identifier is primary;

DGMGRL> add database cdbstb as connect identifier is standby maintained as physical;

DGMGRL> enable configuration;


--Set the property StaticConnectIdentifier to prevent errors during switchover
DGMGRL> edit database cdbprm set property StaticConnectIdentifier="ol7.localdomain:1521/cdbprm_dgmgrl";

DGMGRL> edit database cdbstb set property StaticConnectIdentifier="ol7-stby.localdomain:1521/cdbstb_dgmgrl";


--Check the Data Guard configuration (on both servers)
DGMGRL> show configuration

DGMGRL> show database cdbprm

DGMGRL> show database cdbstb


--Check Data Guard in SQLPlus (on both servers)
SQL> SELECT DATABASE_ROLE, DB_UNIQUE_NAME INSTANCE, OPEN_MODE, PROTECTION_MODE, PROTECTION_LEVEL, SWITCHOVER_STATUS 
FROM V$DATABASE;



